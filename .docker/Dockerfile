FROM node:20-slim AS base
ENV PNPM_HOME="/pnpm"
ENV PATH="$PNPM_HOME:$PATH"

ARG APP_NAME
ARG NEXT_PUBLIC_ENVIRONMENT_INDICATOR_NAME
ARG NEXT_PUBLIC_ENVIRONMENT_INDICATOR_BG_COLOR
ARG NEXT_PUBLIC_ENVIRONMENT_INDICATOR_FG_COLOR
ARG NEXT_PUBLIC_DRUPAL_BASE_URL
ARG NEXT_IMAGE_DOMAIN
ARG DRUPAL_REVALIDATE_SECRET
ARG DRUPAL_CLIENT_ID
ARG DRUPAL_CLIENT_SECRET
ARG NEXTAUTH_URL
ARG NEXTAUTH_SECRET
ARG NEXT_PUBLIC_FRIENDLYCAPTCHA_SITEKEY
ARG NEXT_PUBLIC_DRAFT_REPORT_TERM_IDS

ENV APP_NAME=${APP_NAME} \
    NEXT_PUBLIC_ENVIRONMENT_INDICATOR_NAME=${NEXT_PUBLIC_ENVIRONMENT_INDICATOR_NAME} \
    NEXT_PUBLIC_ENVIRONMENT_INDICATOR_BG_COLOR=${NEXT_PUBLIC_ENVIRONMENT_INDICATOR_BG_COLOR} \
    NEXT_PUBLIC_ENVIRONMENT_INDICATOR_FG_COLOR=${NEXT_PUBLIC_ENVIRONMENT_INDICATOR_FG_COLOR} \
    NEXT_PUBLIC_DRUPAL_BASE_URL=${NEXT_PUBLIC_DRUPAL_BASE_URL} \
    NEXT_IMAGE_DOMAIN=${NEXT_IMAGE_DOMAIN} \
    DRUPAL_REVALIDATE_SECRET=${DRUPAL_REVALIDATE_SECRET} \
    DRUPAL_CLIENT_ID=${DRUPAL_CLIENT_ID} \
    DRUPAL_CLIENT_SECRET=${DRUPAL_CLIENT_SECRET} \
    NEXTAUTH_URL=${NEXTAUTH_URL} \
    NEXTAUTH_SECRET=${NEXTAUTH_SECRET} \
    NEXT_PUBLIC_FRIENDLYCAPTCHA_SITEKEY=${NEXT_PUBLIC_FRIENDLYCAPTCHA_SITEKEY} \
    NEXT_PUBLIC_DRAFT_REPORT_TERM_IDS=${NEXT_PUBLIC_DRAFT_REPORT_TERM_IDS}

RUN corepack enable

FROM base AS build
# this location is only used for the build
COPY . /usr/src/app
WORKDIR /usr/src/app
RUN --mount=type=cache,id=pnpm,target=/pnpm/store pnpm install --frozen-lockfile
RUN pnpm run --filter=${APP_NAME} build
# copies the build to /app
RUN pnpm deploy --filter=${APP_NAME} --prod /app

FROM base AS app
RUN mkdir "/app"
RUN mkdir -p "/app/.shared/"
COPY --from=build /app /app
WORKDIR /app
VOLUME ["/app/.shared/"]
EXPOSE 3000
ENV NODE_ENV production
ENV PORT 3000
ENV HOSTNAME "0.0.0.0"
CMD [ "pnpm", "start" ]
